# Routiium Router Contract — Schema 1.1

This document defines the Router interoperability contract for Routiium following the
Schema **1.1** recommendations. It consolidates the production behaviour implemented in
`src/router_client.rs`, the example server in `examples/router_service.rs`, and the design
principles captured in the latest internal RFCs.

The focus areas are:

- Explicit schema and trace versioning for safe upgrades.
- Precise money/token accounting (minor units, tokenizer identifiers).
- Deterministic cache semantics with stickiness support.
- Enhanced observability (trace context, cache headers, content attestation).
- Richer model catalog metadata for rate-limit aware routing.

---

## TL;DR — 10 Improvements You Get with v1.1

1. **Version the contract**: every request/response carries `schema_version` and the Router emits `Router-Schema: 1.1`.
2. **Traceability**: unique `request_id`, optional W3C `traceparent`/`tracestate`, and consistent `X-Route-*` headers.
3. **Typed errors**: JSON errors include `code`, `message`, `policy_rev`, and `retry_hint_ms`, mapped to canonical HTTP statuses.
4. **Money & tokens**: budgets and estimates use minor units (micro currency) plus `tokenizer_id` hints.
5. **Cache semantics**: plans expose `ttl_ms`, `valid_until`, and `freeze_key`; responses label cache state (`X-Route-Cache`).
6. **Sticky routing**: routers can pin plans across turns using a short-lived `plan_token` in request/response.
7. **Catalog health**: `/catalog/models` publishes `region`, throughput limits, rate-limit policy, and status reasons.
8. **Privacy knobs**: requests send `content_attestation`; plans echo `content_used` so auditors see what was consumed.
9. **Batch/prefetch**: optional endpoints amortise latency for multi-turn flows.
10. **Prompt overlays**: size metadata (`overlay_size_bytes`, `max_overlay_bytes`) guards against oversized injections.

---

## 1. Transport & Negotiation

| Item | Requirement |
|------|-------------|
| Base protocol | HTTP/1.1 or HTTP/2 with keep-alive (Routiium pools 10 idle connections). |
| JSON encoding | UTF-8, `Content-Type: application/json`. |
| Version header | Router responses MUST include `Router-Schema: 1.1`. |
| Cache hint header | Router responses SHOULD include `X-Route-Cache: miss|hit|stale`. |
| Trace headers | Honor `traceparent`/`tracestate` if provided; propagate downstream when possible. |
| Negotiation | `GET /capabilities` (optional) advertises supported features. |
| Security | TLS/mTLS recommended in production. |

Whenever the Router detects an unsupported schema it SHOULD return `409` with
`code: "UNSUPPORTED_SCHEMA"` suggesting the accepted version.

---

## 2. `POST /route/plan` — Request Schema (RouteRequest v1.1)

```jsonc
{
  "schema_version": "1.1",
  "request_id": "req_01JQ2K2C7Y3X",
  "trace": {
    "traceparent": "00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01",
    "tracestate": "vendor=abc"
  },
  "alias": "labiium-001",
  "api": "responses",
  "privacy_mode": "features_only",
  "content_attestation": { "included": "none" },
  "caps": ["text", "tools"],
  "stream": true,
  "params": { "temperature": 0.2, "json_mode": false },
  "plan_token": null,
  "targets": {
    "p95_latency_ms": 3500,
    "min_tokens_per_sec": 300,
    "reliability_tier": "standard"
  },
  "budget": { "amount_micro": 5000, "currency": "USD" },
  "estimates": {
    "prompt_tokens": 1800,
    "max_output_tokens": 512,
    "tokenizer_id": "o200k_base"
  },
  "conversation": {
    "turns": 6,
    "system_fingerprint": "sha256:8f…",
    "history_fingerprint": "sha256:e3…",
    "summary": null
  },
  "org": { "tenant": "uom-ee", "project": "ee101", "role": "student" },
  "geo": { "region": "eu-west-1" },
  "tools": [ { "name": "get_instrument", "json_schema_hash": "sha256:ab…" } ]
}
```

### Field Notes

- `schema_version` MUST be set to `1.1` for new clients; routers should treat absence as `1.0` (legacy).
- `request_id` is generated by the client (Routiium uses a short UUID prefixed with `req_`).
- `trace` container carries W3C trace context; routers may create child spans and return updated `traceparent`.
- `privacy_mode` controls how much content is supplied. `content_attestation.included` publicly documents the level provided (`none`, `summary`, `full`).
- `caps` always includes `text`. Additional entries identify needs (`vision`, `tools`, `code`, etc.).
- `plan_token` is set when reusing a sticky route; absent otherwise.
- `targets` uses explicit units and provides future space for reliability tiers.
- `budget` replaces float-based max cost fields. Amounts are in **micro** currency units.
- `estimates.tokenizer_id` identifies the heuristic (e.g., exact tokenizer or fallback `auto`).
- `geo.region` enables data residency and latency-aware routing.
- Legacy fields (`role`, `task`, `privacy`, `hints`, `targets.max_cost_usd/gbp`) are still deserialised but no longer emitted.

### Validation Guidelines

Routers SHOULD reject requests with unknown `schema_version` unless they can downgrade gracefully. When rejecting, respond `409` with `code: "UNSUPPORTED_SCHEMA"` and include `supported: ["1.0","1.1"]` in the error payload.

---

## 3. `RoutePlan` Response Schema

```jsonc
{
  "schema_version": "1.1",
  "route_id": "rte_7q9abc123def456",
  "upstream": {
    "base_url": "https://api.openai.com/v1",
    "mode": "responses",
    "model_id": "gpt-4o-mini-2024-08-06",
    "auth_env": "OPENAI_API_KEY",
    "headers": { "OpenAI-Beta": "assistants=v2" }
  },
  "limits": {
    "max_input_tokens": 16384,
    "max_output_tokens": 512,
    "timeout_ms": 20000
  },
  "prompt_overlays": {
    "system_overlay": "You are Mesurii…",
    "overlay_fingerprint": "sha256:edu_overlay_v1",
    "overlay_size_bytes": 612,
    "max_overlay_bytes": 16384
  },
  "hints": {
    "tier": "T1",
    "est_cost_micro": 3100,
    "currency": "USD",
    "est_latency_ms": 900,
    "provider": "openai"
  },
  "fallbacks": [
    {
      "base_url": "http://vllm-a:8000/v1",
      "mode": "chat",
      "model_id": "llama3.1-8b-instruct",
      "reason": "provider_ratelimit",
      "penalty": 0.15
    }
  ],
  "cache": {
    "ttl_ms": 15000,
    "etag": "W/\"cat_42@pol_v5\"",
    "valid_until": "2025-11-04T12:00:29Z",
    "freeze_key": "frz_2c6f…"
  },
  "stickiness": {
    "plan_token": "plan_01JP…",
    "max_turns": 3,
    "expires_at": "2025-11-04T12:01:00Z"
  },
  "policy": {
    "revision": "pol_v5",
    "id": "edu_cost_routed_v5",
    "explain": "T1 cheap model selected; budget OK; latency target met"
  },
  "policy_rev": "pol_v5",   // legacy scalar for backwards compatibility
  "content_used": "none"
}
```

### Response Headers

| Header | Description |
|--------|-------------|
| `Router-Schema` | MUST equal `1.1`. |
| `Config-Revision` | Policy revision string to invalidate cached plans. |
| `Router-Latency` | Millisecond latency for generating the plan. |
| `X-Route-Cache` | `miss`, `hit`, or `stale`. |
| `X-Route-Id` / `X-Resolved-Model` / `X-Route-Tier` / `X-Policy-Rev` | Propagated for observability. |
| `X-Content-Used` | Echo of `content_used` for audit logs. |

### Cache & Stickiness Semantics

- `ttl_ms` defines the soft lifetime for reuse. Routiium also honours `valid_until` when provided.
- `freeze_key` lets routers invalidate a single cached plan without altering revisions.
- `stickiness.plan_token` (with optional `max_turns`/`expires_at`) instructs Routiium to reuse the plan for future turns by sending the token back in `RouteRequest.plan_token`.

---

## 4. Error Model (`RouteErrorResponse`)

```jsonc
{
  "schema_version": "1.1",
  "code": "ALIAS_UNKNOWN",
  "message": "Alias 'labiium-001x' not found",
  "request_id": "req_01JQ2K2C7Y3X",
  "policy_rev": "pol_v5",
  "retry_hint_ms": 60000
}
```

Recommended enum → HTTP status mapping:

| Code | HTTP | Meaning |
|------|------|---------|
| `ALIAS_UNKNOWN` | 404 | Alias not registered. |
| `NO_ROUTE` | 409 | Router cannot satisfy requirements (budget, residency, etc.). |
| `POLICY_DENY` | 403 | Policy forbids request. |
| `BUDGET_EXCEEDED` | 402/409 | Budget exhausted. |
| `ROUTER_OVERLOADED` | 503 | Capacity issue. |
| `UPSTREAM_UNHEALTHY` | 502 | No healthy upstreams remain. |
| `INVALID_REQUEST` | 400 | Schema or validation failure. |
| `UNSUPPORTED_SCHEMA` | 409 | See negotiation. |
| `INTERNAL` | 500 | Unexpected error. |

Always include `request_id` and `policy_rev` for correlation. If a retry is advisable, supply `Retry-After` or `retry_hint_ms`.

---

## 5. `POST /route/feedback`

```jsonc
{
  "route_id": "rte_7q9abc123def456",
  "model_id": "gpt-4o-mini-2024-08-06",
  "success": true,
  "duration_ms": 875,
  "usage": { "prompt_tokens": 1800, "completion_tokens": 450, "cached_tokens": 0, "reasoning_tokens": 0 },
  "status_code": 200,
  "actual_cost_micro": 2800,
  "currency": "USD",
  "upstream_error_code": null,
  "rl_applied": false,
  "cache_hit": false,
  "errors": []
}
```

Legacy float fields (`actual_cost_usd`, `input_tokens`, etc.) remain for backwards compatibility but will be removed in a future schema.

Routers MAY respond `200 OK` or `202 Accepted`. Feedback is best-effort and should never block request processing.

---

## 6. Model Catalog (`GET /catalog/models`)

```jsonc
{
  "revision": "cat_v42",
  "models": [
    {
      "id": "gpt-4o-mini-2024-08-06",
      "provider": "openai",
      "region": ["us-east-1", "eu-west-1"],
      "aliases": ["tier:T1", "family:gpt-4o-mini"],
      "capabilities": { "modalities": ["text","image"], "context_tokens": 128000, "tools": true, "json_mode": true, "prompt_cache": true, "structured_output": true },
      "limits": { "tps": 20, "rpm": 1800, "rps_burst": 10 },
      "usage_notes": "Great cost/latency; ideal for hints.",
      "cost": {
        "currency": "USD",
        "input_per_million_micro": 150000,
        "output_per_million_micro": 600000,
        "cached_per_million_micro": 75000
      },
      "slos": {
        "target_p95_ms": 3000,
        "recent": { "p50_ms": 700, "p95_ms": 2100, "error_rate": 0.003, "tokens_per_sec": 450 }
      },
      "policy_tags": ["T1", "edu_safe"],
      "status": "healthy",
      "status_reason": null,
      "rl_policy": "default",
      "deprecated": false,
      "deprecates_at": null
    }
  ]
}
```

Routers should set `ETag` (quoted) and honour `If-None-Match`. Routiium polls the catalog on startup and every 60 seconds.

---

## 7. Batch & Prefetch (Optional)

- `POST /route/plan_batch` — Resolve multiple aliases in one call. Request: `{ "plans": [RouteRequest, …] }`. Response: `{ "plans": [RoutePlan|Error, …], "batch_id": "batch_01K…" }`.
- `POST /route/prefetch` — Warm caches or pre-check health. Request: `{ "alias": "labiium-001", "warm": ["openai", "vllm-a"] }`.

Both endpoints follow the same schema rules and should emit `Router-Schema` headers.

---

## 8. Observability & Headers

| Header | Source | Notes |
|--------|--------|-------|
| `Router-Schema` | Router | Always `1.1`. |
| `Router-Latency` | Router | Milliseconds spent planning. |
| `Config-Revision` | Router | Increment to clear caches. |
| `X-Route-Cache` | Router | `miss`, `hit`, `stale`. |
| `X-Route-Id` | Router | Mirrors response body. |
| `X-Resolved-Model` | Router | Actual model ID. |
| `X-Route-Tier` | Router | e.g., `T1`. |
| `X-Policy-Rev` | Router | Mirrors `policy.revision`. |
| `X-Content-Used` | Router | `none`, `summary`, `full`. |

Routiium propagates these headers to client responses when `ROUTIIUM_EXPOSE_ROUTE_HEADERS=1` is set.

---

## 9. Privacy Controls

- Request side: `privacy_mode` + `content_attestation.included` describe what content was shared.
- Response side: `content_used` and `X-Content-Used` confirm what the Router actually inspected.
- Routers should maintain an allowlist for `privacy_mode="full"` tenants and log `request_id` + `content_used` for audits.

---

## 10. Sticky Routing Workflow

1. Router returns `stickiness.plan_token` in the plan.
2. Routiium stores the token alongside the plan for the configured TTL/turn count.
3. Subsequent client requests include `plan_token` in `RouteRequest` to signal reuse.
4. Router can decide to honour the token (`X-Route-Cache: hit`) or recompute and update the token.

---

## 11. Migration Guidance

- Routiium still accepts legacy 1.0 fields but always emits 1.1 payloads.
- Routers should accept both `targets.p95_latency_ms` and the legacy `latency_p95_ms` aliases during transition.
- Deprecation warnings should be logged when legacy fields (`max_cost_usd`, `role`, etc.) appear to accelerate cleanup.

---

## 12. Reference Implementations

- **Client**: `src/router_client.rs` populates all v1.1 fields when contacting remote routers and fully parses responses.
- **Local Router**: `LocalPolicyRouter` demonstrates schema emission for static alias maps.
- **Example Server**: `examples/router_service.rs` provides an Actix-web implementation with headers, stickiness, and the extended catalog.

---

By adhering to Schema 1.1 your Router gains precise accounting, better traceability, and forward-compatible caching behaviour while maintaining full backwards compatibility with earlier Routiium deployments.
